<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Triangle Drawing â€“ Stable Base</title>

<style>
body {
  padding: 20mm;
  font-family: Arial, sans-serif;
}

h2 { text-align:center }

label {
  font-weight: bold;
  display: block;
  margin-top: 12px;
}

.controls {
  margin: 10px 0;
  display: flex;
  gap: 10px;
  align-items: center;
}

button {
  padding: 6px 12px;
  cursor: pointer;
}

svg {
  background: white;
  touch-action: none;
  user-select: none;
}

.triangle-outline {
  fill: none;
  stroke: green;
  stroke-width: 0.8;
  pointer-events: none;
}

.draw-path {
  fill: none;
  stroke: black;
  stroke-linecap: round;
  stroke-linejoin: round;
}

.signature-line {
  stroke: black;
  stroke-width: 0.3;
}
</style>
</head>

<body>

<h2>Triangle Drawing (Stable)</h2>

<label>Brush Size (mm)</label>
<div class="controls">
  <input id="brushSize" type="range" min="0.1" max="1" step="0.05" value="0.3">
  <span id="brushLabel">0.30 mm</span>
</div>

<label>Triangle</label>
<div class="controls">
  <button onclick="undo(triangleLayer)">Undo</button>
  <button onclick="clearLayer(triangleLayer)">Clear</button>
</div>

<svg id="triangleSvg"
     width="121mm"
     height="146mm"
     viewBox="0 0 121 146">

  <defs>
    <clipPath id="triangleClip">
      <polygon points="60.5,0 121,146 0,146" />
    </clipPath>
  </defs>

  <polygon class="triangle-outline"
           points="60.5,0 121,146 0,146"/>

  <g id="triangleLayer" clip-path="url(#triangleClip)"></g>
</svg>

<label>Signature</label>
<div class="controls">
  <button onclick="undo(signatureLayer)">Undo</button>
  <button onclick="clearLayer(signatureLayer)">Clear</button>
</div>

<svg id="signatureSvg"
     width="121mm"
     height="40mm"
     viewBox="0 0 121 40">

  <line x1="5" y1="30" x2="116" y2="30"
        class="signature-line"/>

  <g id="signatureLayer"></g>
</svg>

<script>
const brush = document.getElementById('brushSize');
const brushLabel = document.getElementById('brushLabel');
brush.oninput = () => {
  brushLabel.textContent = brush.value + ' mm';
};

const stacks = new Map();

function enableDrawing(svg, layer, fixedSize = null) {
  let drawing = false;
  let path;

  stacks.set(layer, []);

  function svgPoint(e) {
    const rect = svg.getBoundingClientRect();
    const vb = svg.viewBox.baseVal;
    return {
      x: (e.clientX - rect.left) * vb.width / rect.width,
      y: (e.clientY - rect.top) * vb.height / rect.height
    };
  }

  svg.addEventListener('pointerdown', e => {
    drawing = true;
    const p = svgPoint(e);

    path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.classList.add('draw-path');
    path.setAttribute('stroke-width', fixedSize ?? brush.value);
    path.setAttribute('d', `M ${p.x} ${p.y}`);

    layer.appendChild(path);
    stacks.get(layer).push(path);

    svg.setPointerCapture(e.pointerId);
  });

  svg.addEventListener('pointermove', e => {
    if (!drawing) return;
    const p = svgPoint(e);
    path.setAttribute(
      'd',
      path.getAttribute('d') + ` L ${p.x} ${p.y}`
    );
  });

  function stop() {
    drawing = false;
    path = null;
  }

  svg.addEventListener('pointerup', stop);
  svg.addEventListener('pointerleave', stop);
}

function undo(layer) {
  const s = stacks.get(layer);
  if (!s.length) return;
  layer.removeChild(s.pop());
}

function clearLayer(layer) {
  while (layer.firstChild) layer.removeChild(layer.firstChild);
  stacks.set(layer, []);
}

const triangleSvg = document.getElementById('triangleSvg');
const signatureSvg = document.getElementById('signatureSvg');
const triangleLayer = document.getElementById('triangleLayer');
const signatureLayer = document.getElementById('signatureLayer');

enableDrawing(triangleSvg, triangleLayer);
enableDrawing(signatureSvg, signatureLayer, 0.3);
</script>

</body>
</html>
