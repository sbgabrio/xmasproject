<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Triangle Drawing Submission</title>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<style>
body{
  padding:20mm;
  font-family:'Comic Sans MS',sans-serif;
  background:#fff9f0;
}
h2{text-align:center;color:#a80000}
label{font-weight:bold;margin-top:12px;display:block}

input[type=text]{width:100%;font-size:16px;padding:6px}

button{
  margin-top:8px;
  padding:8px 14px;
  font-size:16px;
  background:#a80000;
  color:#fff;
  border:none;
  border-radius:6px;
  cursor:pointer;
}

.controls{display:flex;align-items:center;gap:10px;margin-top:6px}

svg{
  touch-action:none;
  background:white;
  border-radius:8px;
}

.triangle{
  width:100%;
  max-width:500px;
  border:2px solid #006400;
}

.signature{
  width:121mm;
  height:40mm;
  border:2px solid #006400;
}

.triangle-outline{
  fill:none;
  stroke:#006400;
  stroke-width:5pt;
  pointer-events:none;
}

.draw-path{
  fill:none;
  stroke:black;
  stroke-linecap:round;
  stroke-linejoin:round;
}

.signature-line{
  stroke:#006400;
  stroke-width:1;
}
</style>
</head>

<body>

<h2>Triangle Drawing</h2>

<label>Typed Name</label>
<input id="typedName" type="text">

<div class="controls">
<label>Brush Size</label>
<input id="brushSize" type="range" min="1" max="15" step="0.5" value="5">
<span id="brushVal">5</span>
</div>

<label>Draw inside the triangle</label>
<button onclick="undo('triangleLayer')">Undo</button>
<button onclick="clearLayer('triangleLayer')">Clear</button>

<svg id="triangleSvg" class="triangle" viewBox="0 0 130 160">
  <defs>
    <clipPath id="clipTri">
      <polygon points="65,5 125,155 5,155"/>
    </clipPath>
  </defs>

  <polygon class="triangle-outline" points="65,5 125,155 5,155"/>
  <g id="triangleLayer" clip-path="url(#clipTri)"></g>
</svg>

<label>Signature</label>
<button onclick="undo('signatureLayer')">Undo</button>
<button onclick="clearLayer('signatureLayer')">Clear</button>

<svg id="signatureSvg" class="signature" viewBox="0 0 121 40">
  <line x1="5" y1="35" x2="116" y2="35" class="signature-line"/>
  <g id="signatureLayer"></g>
</svg>

<br>
<button onclick="preview()">Preview</button>
<button onclick="submitForm()">Submit</button>

<div id="previewArea"></div>

<script>
emailjs.init('2MRCF5mqDT4FkYDi-');

const brush = document.getElementById('brushSize');
const brushVal = document.getElementById('brushVal');
brush.oninput = () => brushVal.textContent = brush.value;

const stacks = {
  triangleLayer: [],
  signatureLayer: []
};

function enableDrawing(svgId, layerId, fixedWidth=null){
  const svg = document.getElementById(svgId);
  const layer = document.getElementById(layerId);
  const ns = "http://www.w3.org/2000/svg";
  let path = null;
  let last = null;

  function svgPoint(e){
    const r = svg.getBoundingClientRect();
    const vb = svg.viewBox.baseVal;
    return {
      x:(e.clientX-r.left)*(vb.width/r.width),
      y:(e.clientY-r.top)*(vb.height/r.height)
    };
  }

  svg.addEventListener('pointerdown', e=>{
    const p = svgPoint(e);
    path = document.createElementNS(ns,'path');
    path.setAttribute('class','draw-path');
    path.setAttribute('stroke-width',(fixedWidth ?? brush.value)+'pt');
    path.setAttribute('d',`M ${p.x} ${p.y}`);
    layer.appendChild(path);
    last = p;
    svg.setPointerCapture(e.pointerId);
  });

  svg.addEventListener('pointermove', e=>{
    if(!path) return;
    const p = svgPoint(e);
    const dx = p.x-last.x;
    const dy = p.y-last.y;
    if(Math.hypot(dx,dy) < 0.8) return;

    const mx = (last.x+p.x)/2;
    const my = (last.y+p.y)/2;
    path.setAttribute('d',
      path.getAttribute('d') + ` Q ${last.x} ${last.y} ${mx} ${my}`
    );
    last = p;
  });

  function end(){
    if(path){
      stacks[layerId].push(path);
      path = null;
    }
  }

  svg.addEventListener('pointerup', end);
  svg.addEventListener('pointerleave', end);
}

enableDrawing('triangleSvg','triangleLayer');
enableDrawing('signatureSvg','signatureLayer',1);

function undo(layerId){
  const layer = document.getElementById(layerId);
  const s = stacks[layerId];
  if(s.length) layer.removeChild(s.pop());
}

function clearLayer(layerId){
  const layer = document.getElementById(layerId);
  stacks[layerId]=[];
  while(layer.firstChild) layer.removeChild(layer.firstChild);
}

function svgExport(svgId, removeSelector=null){
  const svg = document.getElementById(svgId);
  const clone = svg.cloneNode(true);
  if(removeSelector)
    clone.querySelectorAll(removeSelector).forEach(n=>n.remove());
  return new XMLSerializer().serializeToString(clone);
}

function preview(){
  document.getElementById('previewArea').innerHTML =
    svgExport('triangleSvg','.triangle-outline');
}

function submitForm(){
  const name = typedName.value.trim();
  if(!name) return alert("Type your name");

  emailjs.send('service_8s9eadc','template_jm26nk5',{
    student_name:name,
    triangle_svg:svgExport('triangleSvg','.triangle-outline'),
    signature_svg:svgExport('signatureSvg')
  });

  alert("Submitted!");
}
</script>

</body>
</html>
