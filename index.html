<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Triangle Drawing Submission</title>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<style>
body { padding:20mm; font-family:'Comic Sans MS', sans-serif; background:linear-gradient(to bottom,#fff9f0,#ffe6e6); color:#333;}
h2{text-align:center;color:#a80000;text-shadow:1px 1px #fff;}
label{font-weight:bold;display:block;margin-top:12px;color:#a80000;}
input[type="text"]{width:100%; font-size:16px;padding:6px;border:2px solid #a80000;border-radius:5px;}
button{margin-top:10px;padding:8px 16px;font-size:16px;cursor:pointer;background-color:#a80000;color:white;border:none;border-radius:8px;}
.controls, .button-group { display:flex; gap:10px; margin-top:5px; flex-wrap:wrap; align-items:center;}
svg{touch-action:none;display:block;border-radius:10px;margin:10px 0;background:rgba(255,255,255,0.8);}
.triangle-outline{fill:none;stroke:#006400;stroke-width:5pt;pointer-events:none;}
.triangle{width:100%;max-height:600px;border:2px solid #006400;position:relative;}
.signature{width:121mm;height:40mm;border:2px solid #006400;}
.signature-line{stroke:#006400;stroke-width:1;}
.brush-btn{width:30px;height:30px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid #a80000;border-radius:50%;background:white;}
#brushPreview{display:inline-block;vertical-align:middle;}
#previewContainer img{max-width:100%; border:1px solid #a80000; margin:10px 0;}
</style>
</head>
<body>

<h2>Triangle Drawing</h2>

<label>Typed Name</label>
<input id="typedName" type="text" placeholder="Type your name" />

<div class="controls">
<label>Brush Selector</label>
<div id="brushOptions" style="display:flex; gap:10px; align-items:center;">
<div class="brush-btn" data-size="5" data-shape="circle"><svg width="20" height="20"><circle cx="10" cy="10" r="5" fill="black"/></svg></div>
<div class="brush-btn" data-size="5" data-shape="square"><svg width="20" height="20"><rect x="5" y="5" width="10" height="10" fill="black"/></svg></div>
<div class="brush-btn" data-size="5" data-shape="diamond"><svg width="20" height="20"><polygon points="10,2 18,10 10,18 2,10" fill="black"/></svg></div>
<div class="brush-btn" data-size="5" data-shape="triangle"><svg width="20" height="20"><polygon points="10,2 18,18 2,18" fill="black"/></svg></div>
<button id="decreaseBrush">â€“</button>
<button id="increaseBrush">+</button>
<div id="brushPreview"></div>
</div>
</div>

<div class="controls">
<label>Smoothing Level</label>
<button data-smoothing="2" class="smooth-btn">Low</button>
<button data-smoothing="5" class="smooth-btn">Medium</button>
<button data-smoothing="10" class="smooth-btn">High</button>
<span id="currentSmoothing" style="margin-left:10px;">Medium</span>
</div>

<label>Draw inside the triangle</label>
<div class="button-group">
<button onclick="undo(triangleLayer)">Undo</button>
<button onclick="clearLayer(triangleLayer)">Clear</button>
</div>
<svg id="triangleSvg" class="triangle" viewBox="0 0 130 160">
<polygon class="triangle-outline" points="65,5 125,155 5,155"/>
<g id="triangleLayer"></g>
</svg>

<label>Signature</label>
<div class="button-group">
<button onclick="undo(signatureLayer)">Undo</button>
<button onclick="clearLayer(signatureLayer)">Clear</button>
</div>
<svg id="signatureSvg" class="signature" viewBox="0 0 121 40">
<line x1="5" y1="35" x2="116" y2="35" class="signature-line" />
<g id="signatureLayer"></g>
</svg>

<div class="button-group">
<button onclick="submitForm()">Submit</button>
<button onclick="previewDrawing()">Preview</button>
<button onclick="downloadPNG()">Download PNG</button>
</div>
<div id="previewContainer"></div>

<script>
emailjs.init('2MRCF5mqDT4FkYDi-');
let brushSizeValue=5, brushShape='circle', smoothingLevel=5;
const brushPreview=document.getElementById('brushPreview');

function updateBrushPreview(){
    brushPreview.innerHTML='';
    const svgNS='http://www.w3.org/2000/svg';
    const s=document.createElementNS(svgNS,'svg'); s.setAttribute('width','40'); s.setAttribute('height','40');
    let shape;
    switch(brushShape){
        case 'circle': shape=document.createElementNS(svgNS,'circle'); shape.setAttribute('cx','20'); shape.setAttribute('cy','20'); shape.setAttribute('r',brushSizeValue/2); break;
        case 'square': shape=document.createElementNS(svgNS,'rect'); const offset=20-brushSizeValue/2; shape.setAttribute('x',offset); shape.setAttribute('y',offset); shape.setAttribute('width',brushSizeValue); shape.setAttribute('height',brushSizeValue); break;
        case 'diamond': const half=brushSizeValue/2; shape=document.createElementNS(svgNS,'polygon'); shape.setAttribute('points',`${20},${20-half} ${20+half},20 ${20},${20+half} ${20-half},20`); break;
        case 'triangle': const h=brushSizeValue; shape=document.createElementNS(svgNS,'polygon'); shape.setAttribute('points',`${20},${20-h/2} ${20+h/2},${20+h/2} ${20-h/2},${20+h/2}`); break;
    }
    shape.setAttribute('fill','black'); s.appendChild(shape);
    brushPreview.appendChild(s);
}
updateBrushPreview();
document.querySelectorAll('.brush-btn').forEach(btn=>btn.addEventListener('click',()=>{
    brushSizeValue=parseFloat(btn.dataset.size); brushShape=btn.dataset.shape; updateBrushPreview();
}));
document.getElementById('increaseBrush').addEventListener('click',()=>{brushSizeValue=Math.min(15,brushSizeValue+0.5); updateBrushPreview();});
document.getElementById('decreaseBrush').addEventListener('click',()=>{brushSizeValue=Math.max(1,brushSizeValue-0.5); updateBrushPreview();});
document.querySelectorAll('.smooth-btn').forEach(btn=>btn.addEventListener('click',()=>{
    smoothingLevel=parseFloat(btn.dataset.smoothing); document.getElementById('currentSmoothing').textContent=btn.textContent;
    updateBrushPreview();
}));

let pathsStack={ triangleLayer:[], signatureLayer:[] };
function pointInTriangle(px, py, ax, ay, bx, by, cx, cy){
    const v0x=cx-ax, v0y=cy-ay, v1x=bx-ax, v1y=by-ay, v2x=px-ax, v2y=py-ay;
    const dot00=v0x*v0x+v0y*v0y, dot01=v0x*v1x+v0y*v1y, dot02=v0x*v2x+v0y*v2y;
    const dot11=v1x*v1x+v1y*v1y, dot12=v1x*v2x+v1y*v2y;
    const invDenom=1/(dot00*dot11-dot01*dot01);
    const u=(dot11*dot02-dot01*dot12)*invDenom;
    const v=(dot00*dot12-dot01*dot02)*invDenom;
    return (u>=0)&&(v>=0)&&(u+v<=1);
}

function enableSmoothDrawing(svg, layer, fixedStroke=null, clipTriangle=null){
    const svgNS='http://www.w3.org/2000/svg';
    let path,lastPoint=null;
    svg.addEventListener('pointerdown', e=>{
        e.preventDefault();
        const r=svg.getBoundingClientRect(); const vb=svg.viewBox.baseVal;
        const x=(e.clientX-r.left)*(vb.width/r.width); const y=(e.clientY-r.top)*(vb.height/r.height);
        if(clipTriangle && !pointInTriangle(x,y,65,5,125,155,5,155)) return;
        path=document.createElementNS(svgNS,'path');
        path.setAttribute('stroke-linecap','round'); path.setAttribute('stroke-linejoin','round'); path.setAttribute('fill','none');
        path.setAttribute('stroke','black'); path.setAttribute('stroke-width',(fixedStroke!==null?fixedStroke:brushSizeValue)+'pt');
        path.setAttribute('d',`M ${x} ${y}`);
        layer.appendChild(path); lastPoint={x,y};
    });
    svg.addEventListener('pointermove', e=>{
        if(!path) return;
        const r=svg.getBoundingClientRect(); const vb=svg.viewBox.baseVal;
        const x=(e.clientX-r.left)*(vb.width/r.width); const y=(e.clientY-r.top)*(vb.height/r.height);
        if(clipTriangle && !pointInTriangle(x,y,65,5,125,155,5,155)) return;
        if(lastPoint){
            const midX=(lastPoint.x+x)/2, midY=(lastPoint.y+y)/2;
            let d=path.getAttribute('d');
            for(let i=1;i<=smoothingLevel;i++){
                const t=i/(smoothingLevel+1);
                const interpX=lastPoint.x*(1-t)+x*t; const interpY=lastPoint.y*(1-t)+y*t;
                d+=` L ${interpX} ${interpY}`;
            }
            path.setAttribute('d',d);
        }
        lastPoint={x,y};
    });
    svg.addEventListener('pointerup', e=>{ if(path) pathsStack[layer.id].push([path]); path=null; lastPoint=null; });
    svg.addEventListener('pointerleave', e=>{ if(path) pathsStack[layer.id].push([path]); path=null; lastPoint=null; });
}

const triangleLayer=document.getElementById('triangleLayer');
const signatureLayer=document.getElementById('signatureLayer');
const triangleSvg=document.getElementById('triangleSvg');
const signatureSvg=document.getElementById('signatureSvg');

enableSmoothDrawing(triangleSvg, triangleLayer, null, true);
enableSmoothDrawing(signatureSvg, signatureLayer,1);

function undo(layer){ const strokes=pathsStack[layer.id]; if(strokes.length){ const lastStroke=strokes.pop(); lastStroke.forEach(el=>layer.removeChild(el)); } }
function clearLayer(layer){ while(layer.firstChild) layer.removeChild(layer.firstChild); pathsStack[layer.id]=[]; }

async function svgToPng(svg, excludeSelector=null, scale=10){
    return new Promise(resolve=>{
        const vb=svg.viewBox.baseVal; 
        const clone=svg.cloneNode(true);
        if(excludeSelector) clone.querySelectorAll(excludeSelector).forEach(n=>n.remove());
        const xml=new XMLSerializer().serializeToString(clone);
        const img=new Image();
        img.crossOrigin="anonymous";
        img.onload=()=>{ const c=document.createElement('canvas'); c.width=vb.width*scale; c.height=vb.height*scale;
            const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); ctx.scale(scale,scale); ctx.drawImage(img,0,0);
            resolve(c.toDataURL('image/png'));};
        img.src='data:image/svg+xml;base64,'+btoa(unescape(encodeURIComponent(xml)));
    });
}

async function submitForm(){
    const name=typedName.value.trim(); if(!name) return alert('Type your name');
    const tri=await svgToPng(triangleSvg,'.triangle-outline');
    const sig=await svgToPng(signatureSvg);
    emailjs.send('service_8s9eadc','template_jm26nk5',{student_name:name,triangle_image:tri,signature_image:sig,to_email:'stevegabrio@gmail.com'});
    alert('Submitted!');
}

async function previewDrawing(){
    const triData = await svgToPng(triangleSvg,'.triangle-outline',5); 
    const sigData = await svgToPng(signatureSvg, null, 5);
    const container = document.getElementById('previewContainer');
    container.innerHTML='';
    const previewCanvas=document.createElement('canvas'); const scale=5;
    previewCanvas.width=130*scale; previewCanvas.height=160*scale;
    const ctx=previewCanvas.getContext('2d');
    const woodImg=new Image(); woodImg.crossOrigin="anonymous";
    woodImg.onload=()=>{
        ctx.save(); ctx.beginPath(); ctx.moveTo(65*scale,5*scale); ctx.lineTo(125*scale,155*scale); ctx.lineTo(5*scale,155*scale); ctx.closePath(); ctx.clip();
        ctx.drawImage(woodImg,0,0,130*scale,160*scale);
        const strokesImg=new Image();
        strokesImg.onload=()=>{ ctx.drawImage(strokesImg,0,0,130*scale,160*scale); container.appendChild(previewCanvas); };
        strokesImg.src=triData;
    };
    woodImg.src='https://www.sketchuptextureclub.com/public/texture_d/68-cherry-wood-fine-medium-color-texture-seamless-hr.jpg';
    const sigImg=document.createElement('img'); sigImg.src=sigData; container.appendChild(sigImg);
}

async function downloadPNG(){
    const triData = await svgToPng(triangleSvg,'.triangle-outline',10); 
    const canvas=document.createElement('canvas'); const scale=10;
    canvas.width=130*scale; canvas.height=160*scale;
    const ctx=canvas.getContext('2d');
    const woodImg=new Image(); woodImg.crossOrigin="anonymous";
    woodImg.onload=()=>{
        ctx.save(); ctx.beginPath(); ctx.moveTo(65*scale,5*scale); ctx.lineTo(125*scale,155*scale); ctx.lineTo(5*scale,155*scale); ctx.closePath(); ctx.clip();
        ctx.drawImage(woodImg,0,0,130*scale,160*scale);
        const strokesImg=new Image();
        strokesImg.onload=()=>{ ctx.drawImage(strokesImg,0,0,130*scale,160*scale);
            const link=document.createElement('a'); link.href=canvas.toDataURL('image/png'); link.download='triangle_drawing.png';
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };
        strokesImg.src=triData;
    };
    woodImg.src='./cherry.jpg';
}
</script>
</body>
</html>
