<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Triangle Drawing Submission</title>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 20mm;
      font-family: sans-serif;
      background: white;
    }

    h1 { font-size: 18px; margin-bottom: 10px; }
    label { font-weight: bold; display: block; margin-top: 12px; }

    input[type="text"] {
      width: 100%;
      font-size: 16px;
      padding: 6px;
      box-sizing: border-box;
    }

    button {
      margin-top: 16px;
      padding: 10px 16px;
      font-size: 16px;
      cursor: pointer;
    }

    .canvas-wrapper {
      margin-top: 10px;
    }

    svg {
      width: 121mm;
      height: 146mm;
      border: 1px solid black;
      touch-action: none;
      display: block;
    }

    .triangle-outline {
      fill: none;
      stroke: black;
      stroke-width: 5pt;
    }

    .draw-path {
      fill: none;
      stroke: black;
      stroke-width: 2pt;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .signature {
      width: 121mm;
      height: 40mm;
      border: 1px solid black;
      touch-action: none;
      display: block;
    }

    @media print {
      button { display: none; }
    }
  </style>
</head>
<body>

<h1>Triangle Drawing Worksheet</h1>

<label>Name (typed)</label>
<input id="typedName" type="text" placeholder="Type your name" />

<label>Draw inside the triangle</label>
<div class="canvas-wrapper">
  <svg id="triangleSvg" viewBox="0 0 121 146">
    <defs>
      <clipPath id="clipTriangle">
        <polygon points="60.5,0 121,146 0,146" />
      </clipPath>
    </defs>

    <polygon class="triangle-outline" points="60.5,0 121,146 0,146" />
    <g id="triangleLayer" clip-path="url(#clipTriangle)"></g>
  </svg>
</div>

<label>Signature (sign with finger or mouse)</label>
<svg id="signatureSvg" class="signature" viewBox="0 0 121 40">
  <g id="signatureLayer"></g>
</svg>

<button onclick="submitForm()">Submit</button>

<script>
  /* =========================
     EmailJS initialization
     ========================= */
  emailjs.init('YOUR_PUBLIC_KEY');

  /* =========================
     Generic SVG drawing logic
     ========================= */
  function enableDrawing(svg, layer) {
    let drawing = false;
    let path = null;

    function getPoint(evt) {
      const rect = svg.getBoundingClientRect();
      const vb = svg.viewBox.baseVal;
      return {
        x: (evt.clientX - rect.left) * (vb.width / rect.width),
        y: (evt.clientY - rect.top) * (vb.height / rect.height)
      };
    }

    svg.addEventListener('pointerdown', e => {
      drawing = true;
      const p = getPoint(e);
      path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('class', 'draw-path');
      path.setAttribute('d', `M ${p.x} ${p.y}`);
      layer.appendChild(path);
      svg.setPointerCapture(e.pointerId);
    });

    svg.addEventListener('pointermove', e => {
      if (!drawing || !path) return;
      const p = getPoint(e);
      path.setAttribute('d', path.getAttribute('d') + ` L ${p.x} ${p.y}`);
    });

    function stop(e) {
      drawing = false;
      path = null;
      try { svg.releasePointerCapture(e.pointerId); } catch {}
    }

    svg.addEventListener('pointerup', stop);
    svg.addEventListener('pointerleave', stop);
  }

  enableDrawing(
    document.getElementById('triangleSvg'),
    document.getElementById('triangleLayer')
  );

  enableDrawing(
    document.getElementById('signatureSvg'),
    document.getElementById('signatureLayer')
  );

  /* =========================
     Convert SVG to PNG
     ========================= */
  function svgToPng(svg) {
    return new Promise(resolve => {
      const xml = new XMLSerializer().serializeToString(svg);
      const svg64 = btoa(unescape(encodeURIComponent(xml)));
      const image64 = 'data:image/svg+xml;base64,' + svg64;

      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        canvas.getContext('2d').drawImage(img, 0, 0);
        resolve(canvas.toDataURL('image/png'));
      };
      img.src = image64;
    });
  }

  /* =========================
     Submit handler
     ========================= */
  async function submitForm() {
    const name = document.getElementById('typedName').value.trim();
    if (!name) {
      alert('Please type your name first');
      return;
    }

    const triangleImg = await svgToPng(document.getElementById('triangleSvg'));
    const signatureImg = await svgToPng(document.getElementById('signatureSvg'));

    emailjs.send('service_8s9eadc', 'template_jm26nk5', {
      student_name: name,
      triangle_image: triangleImg,
      signature_image: signatureImg,
      to_email: 'stevegabrio@gmail.com'
    }).then(() => {
      alert('Submitted successfully!');
    }, err => {
      console.error(err);
      alert('Failed to send email');
    });
  }
</script>

</body>
</html>
